# 0x2 搭建微服务项目

本节将指导你基于 go-zero 框架完成一个 gRPC 微服务的创建、运行与调试，并补充常见问题排查及进阶拓展建议。

## 课程目标
- 搭建 go-zero RPC 微服务项目的基础骨架。
- 启动并调试服务，理解核心配置项。
- 使用 BloomRPC 等工具调用并验证 RPC 方法。

## 环境准备
- Go 运行时（推荐 1.20 及以上）。
- goctl 命令行工具：`go install github.com/zeromicro/go-zero/tools/goctl@latest`
- protoc 及插件：`protoc-gen-go`、`protoc-gen-go-grpc`、`goctl` 的 `zrpc` 插件。
- 将 `$GOPATH/bin` 添加到系统 `PATH`，确保终端可直接调用上述工具。

> Tip：执行 `goctl -v` 验证 goctl 是否安装成功，避免路径配置问题。

## 快速入门

### 1. 创建微服务骨架
在目标工作目录执行：

```bash
goctl rpc new <ServiceName>
```

- `<ServiceName>` 为服务名称，例如 `consumer`。
- 命令会生成带有示例 proto、服务实现与配置模板的工程目录。

### 2. 核心目录与文件说明
- `etc/consumer.yaml`：服务配置文件，包含监听端口、注册中心等信息。
- `internal/logic`：业务逻辑实现目录。
- `internal/svc`：依赖注入与资源初始化。
- `consumer.go`：服务入口，负责加载配置并启动 gRPC Server。
- `consumer.proto`：RPC 接口与数据结构定义。修改后需重新生成代码。

### 3. 配置服务
若暂不接入 Etcd，可在 `etc/consumer.yaml` 中注释掉 Etcd 配置段，避免服务启动时报错。

```yaml
# Etcd:
#   Hosts:
#     - 127.0.0.1:2379
#   Key: data-server.rpc
```

同时保留 `ListenOn: 0.0.0.0:8080` 等必要字段，确保服务能够对外监听。

### 4. 启动与验证
在项目根目录执行：

```bash
go run data-server.go
```

- 观察控制台输出，确认服务启动并监听在配置的端口。
- 如需后台运行，可结合 `nohup`、`pm2` 或操作系统服务管理工具。

> 若端口被占用，可修改 `etc/consumer.yaml` 内的 `ListenOn` 字段后重新启动。

### 5. 调用 RPC 接口
1. 下载 BloomRPC：https://github.com/bloomrpc/bloomrpc/releases 并安装。
2. 将 `consumer.proto` 导入 BloomRPC，确认接口列表加载成功。
3. 在 Env 配置中填写服务地址，例如 `127.0.0.1:8080`。
4. 选择需要调用的 RPC 方法，填写请求参数并点击执行。
5. 查看响应结果，验证服务逻辑。

> 如果提示无法连接，请确认服务已运行、端口无防火墙限制且请求的地址与端口正确。

## 推荐工作流
- 修改 `consumer.proto` 后执行生成命令：  
  `goctl rpc protoc consumer.proto --go_out=. --go-grpc_out=. --zrpc_out=.`
- 在 `internal/logic` 下实现具体业务逻辑，并补充单元测试。
- 使用 `makefile` 或脚本封装常用命令，提升开发效率。
- 建立本地或 CI 测试流程，保持接口稳定。

## 常见问题排查
- **Etcd 连接失败**：确认服务是否启用 Etcd。如暂不需要，可注释配置；需要时请确保 Etcd 地址与端口正确。
- **端口冲突**：使用 `netstat`、`lsof` 等命令定位占用端口的进程，释放后重新启动服务。
- **Proto 修改后不生效**：确认执行了生成命令，并在 IDE 中刷新依赖缓存。
- **BloomRPC 无法访问**：核对服务监听地址，必要时关闭或配置系统防火墙、开启端口转发。

## 进阶与拓展
- 利用 go-zero 的 `goctl api` 命令生成 REST 网关，实现 BFF 层。
- 引入服务注册发现（Etcd/Consul）与配置中心，提升扩展能力。
- 集成监控链路，如 Prometheus、Jaeger，完善可观测性。
- 在 Docker/Kubernetes 中部署服务，实践环境隔离、滚动升级等能力。

完成以上步骤后，你将具备 go-zero 微服务项目的基础构建、调试与验证能力，可在此基础上结合业务需求继续扩展。
